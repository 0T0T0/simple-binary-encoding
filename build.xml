<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="Real-Logic-SBE" default="all" basedir=".">

    <property file="build.properties"/>
    <property name="module.name" value="sbe"/>
    <property name="dir.main.src" location="main/java"/>
    <property name="dir.main.build" location="target/main/java/classes"/>
    <property name="dir.test.src" location="test/java"/>
    <property name="dir.test.build" location="target/test/java/classes"/>
    <property name="dir.test.lib" location="test/lib"/>
    <property name="dir.reports" location="target/reports"/>

    <property name="dir.reports.unit" location="target/reports/unit"/>
    <property name="dir.dist" location="target/dist"/>
    <property name="dir.main.resources" location="main/resources"/>
    <property name="dir.test.resources" location="test/resources"/>

    <property name="dir.reports.checkstyle" location="target/reports/checkstyle"/>
    <property name="checkstyle.lib" location="test/lib/checkstyle-5.6-all.jar"/>
    <property name="checkstyle.config.file" location="test/conf/checkstyle.xml"/>
    <property name="checkstyle.output.file" location="${dir.reports.checkstyle}/results.xml"/>

    <property name="dir.docs" value="target/docs"/>

    <property name="cpptasks.lib" location="main/lib/cpptasks-1.0b5.jar"/>
    <property name="dir.main.cpp.src" location="main/cpp"/>
    <property name="dir.main.cpp.build" location="target/main/cpp/obj"/>
    <property name="dir.gtest.src" location="test/cpp/gtest"/>
    <property name="dir.gtest.include" location="test/cpp/gtest/include"/>
    <property name="dir.gtest.build" location="target/test/cpp/gtest/obj"/>
    <property name="dir.test.cpp.src" location="test/cpp"/>
    <property name="lib.gtest.name" location="gtest"/>
    <property name="lib.gtest.path" location="target/test/cpp"/>
    <property name="exec.test.cpp" location="target/test/cpp/gtest-runner"/>

    <path id="test.classpath">
        <pathelement path="${dir.main.build}"/>
        <pathelement path="${dir.test.build}"/>
        <pathelement path="${dir.test.resources}"/>
        <fileset dir="${dir.test.lib}">
            <include name="*.jar"/>
        </fileset>
    </path>

    <taskdef resource="checkstyletask.properties" classpath="${checkstyle.lib}"/>
    <taskdef resource="cpptasks.tasks" classpath="${cpptasks.lib}"/>
    <taskdef resource="cpptasks.types" classpath="${cpptasks.lib}"/>

    <target name="init">
        <tstamp/>
        <mkdir dir="${dir.main.build}"/>
        <mkdir dir="${dir.test.build}"/>
        <mkdir dir="${dir.dist}"/>
        <mkdir dir="${dir.docs}"/>
        <mkdir dir="${dir.reports}"/>
        <mkdir dir="${dir.reports.unit}"/>
        <mkdir dir="${dir.reports.checkstyle}"/>
        <mkdir dir="${dir.main.cpp.build}"/>
        <mkdir dir="${dir.gtest.build}"/>
    </target>

    <target name="checkstyle" depends="init">
        <checkstyle config="${checkstyle.config.file}"
                    failOnViolation="true"
                    maxWarnings="0"
                    maxErrors="0">
            <fileset dir="${dir.main.src}">
                <include name="**/*.java"/>
            </fileset>
            <fileset dir="${dir.test.src}">
                <include name="**/*.java"/>
            </fileset>
            <formatter type="plain"/>
            <formatter type="xml" tofile="${checkstyle.output.file}"/>
        </checkstyle>
    </target>

    <target name="clean" description="Delete all existing output">
        <delete dir="target"/>
    </target>

    <target name="build" depends="init" description="Build the main source">
        <javac srcdir="${dir.main.src}" destdir="${dir.main.build}" includeAntRuntime="false" debug="true">
            <compilerarg value="-Xlint:unchecked"/>
            <compilerarg value="-XDignore.symbol.file"/>
        </javac>
    </target>

    <target name="test" depends="build" description="Unit Test">
        <sequential>
            <javac srcdir="${dir.test.src}" destdir="${dir.test.build}" includeAntRuntime="false" debug="true">
                <classpath refid="test.classpath"/>
                <compilerarg value="-Xlint:unchecked"/>
                <compilerarg value="-XDignore.symbol.file"/>
            </javac>
            <junit printsummary="withOutAndErr" errorProperty="test.failed" failureProperty="test.failed">
                <sysproperty key="results.dir" value="${dir.reports.unit}"/>
                <classpath refid="test.classpath"/>
                <formatter type="xml"/>
                <formatter type="plain" usefile="false"/>
                <batchtest fork="true" todir="${dir.reports.unit}">
                    <fileset dir="${dir.test.src}">
                        <include name="**/*Test.java"/>
                    </fileset>
                </batchtest>
            </junit>
            <junitreport todir="${dir.reports.unit}">
                <fileset dir="${dir.reports.unit}">
                    <include name="TEST-*.xml"/>
                </fileset>
                <report todir="${dir.reports.unit}"/>
            </junitreport>
            <fail message="Tests failed. Check log and/or reports." if="test.failed"/>
        </sequential>
    </target>

    <target name="javadoc" depends="build">
        <javadoc sourcepath="${dir.main.src}"
                 destdir="${dir.docs}"
                 overview="${dir.main.src}/overview.html"
                 author="true"
                 version="true"
                 use="true"
                 windowtitle="Simple Binary Encoding">
            <arg value="-XDignore.symbol.file"/>
            <doctitle><![CDATA[<h1>Simple Binary Encoding</h1>]]></doctitle>
            <bottom><![CDATA[<i>Copyright &#169; 2013 Real Logic Ltd. All Rights Reserved.</i>]]></bottom>
        </javadoc>
    </target>

    <target name="dist" depends="build, javadoc" description="Generate the distribution">
        <jar destfile="${dir.dist}/${module.name}-${build.version}-${DSTAMP}.jar">
            <manifest>
                <attribute name="Main-Class" value="uk.co.real_logic.sbe.SbeTool"/>
            </manifest>
            <fileset dir="${dir.main.build}"/>
        </jar>
        <jar destfile="${dir.dist}/${module.name}-api-${build.version}-${DSTAMP}.jar">
            <fileset dir="${dir.docs}"/>
        </jar>
        <jar destfile="${dir.dist}/${module.name}-src-${build.version}-${DSTAMP}.jar">
            <fileset dir="${dir.main.src}"/>
        </jar>
    </target>

    <target name="all" depends="clean, checkstyle, build, test, javadoc, dist"/>

    <!-- C++ related targets -->

    <target name="cpp:compile" depends="clean, init">
        <cc outtype="static"
            debug="true"
            subsystem="console"
            objdir="${dir.main.cpp.build}">
            <includepath path="${dir.main.cpp.src}"/>
            <compilerarg value="-std=c++98"/>
            <fileset dir="${dir.main.cpp.src}" includes="**/*.cpp"/>
        </cc>
    </target>

    <target name="cpp:test" depends="cpp:compile">
        <sequential>
            <!-- gtest compile -->
            <cc outtype="static"
                subsystem="console"
                debug="true"
                multithreaded="true"
                exceptions="true"
                objdir="${dir.gtest.build}">
                <includepath path="${dir.gtest.include}"/>
                <includepath path="${dir.gtest.src}"/>
                <fileset dir="${dir.gtest.src}">
                    <include name="src/gtest-all.cc"/>
                    <include name="src/gtest_main.cc"/>
                </fileset>
            </cc>
            <!-- all tests are placed in the main runner -->
            <cc outtype="executable"
                subsystem="console"
                debug="true"
                outfile="${exec.test.cpp}">
                <includepath path="${dir.gtest.include}"/>
                <includepath path="${dir.main.cpp.src}"/>
                <fileset dir="${dir.main.cpp.build}" includes="*.o"/>
                <fileset dir="${dir.gtest.build}" includes="*.o"/>
                <fileset dir="${dir.test.cpp.src}" includes="**/*Test.cpp"/>
                <libset libs="stdc++"/>
            </cc>
            <exec executable="${exec.test.cpp}" failonerror="true">
                <arg value="--gtest_color=no"/>
            </exec>
        </sequential>
    </target>
</project>
